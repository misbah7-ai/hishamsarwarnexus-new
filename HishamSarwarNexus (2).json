{
  "name": "HishamSarwarNexus",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "learning-research",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "a768cf64-b8da-4395-a7da-f29d9beb3d06",
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        -672,
        96
      ],
      "webhookId": "53072b2f-78fe-45a9-b261-8b123d22999e"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "id-1",
              "name": "supabaseUrl",
              "value": 
              "type": "string"
            },
            {
              "id": "id-2",
              "name": "booksTableName",
              "value": "books_table",
              "type": "string"
            },
            {
              "id": "id-3",
              "name": "youtubeTableName",
              "value": "youtube_table",
              "type": "string"
            },
            {
              "id": "id-4",
              "name": "topKResults",
              "value": 5,
              "type": "number"
            },
            {
              "id": "id-5",
              "name": "hishamSarwarYouTubeChannel",
              "value": 
              "type": "string"
            },
            {
              "id": "id-6",
              "name": "officialYouTubeURL",
              "value": "https://youtube.com/@hishamsarwar",
              "type": "string"
            },
            {
              "id": "id-7",
              "name": "officialFacebookURL",
              "value": "https://facebook.com/hishamsarwar",
              "type": "string"
            },
            {
              "id": "id-8",
              "name": "officialInstagramURL",
              "value": "https://instagram.com/hishamsarwar",
              "type": "string"
            },
            {
              "id": "id-9",
              "name": "officialWebsiteURL",
              "value": "https://hishamsarwar.com",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true,
        "options": {}
      },
      "id": 
      "name": "Workflow Configuration",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -448,
        96
      ]
    },
    {
      "parameters": {
        "jsCode": "// Extract data from webhook body - handle both direct body and nested body structure\nconst webhookBody = $input.item.json.body || $input.item.json;\n\n// Extract the required fields\nconst userQuery = webhookBody.query || '';\nconst preferredOutputFormat = webhookBody.preferred_output_format || 'summary';\nconst selectedBook = webhookBody.selected_book || null;\nconst selectedVideo = webhookBody.selected_video || null;\n\n// Prepare the data for vector search\n// Note: Embeddings will be generated by Supabase vector search functions\nconst searchData = {\n  query: userQuery,\n  preferred_output_format: preferredOutputFormat,\n  selected_book: selectedBook,\n  selected_video: selectedVideo\n};\n\n// Return the prepared data\nreturn [{ json: searchData }];"
      },
      "id": 
      "name": "Prepare Vector Search Query",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -224,
        96
      ]
    },
    {
      "parameters": {
        "jsCode": "const queryData = $('Prepare Vector Search Query').first().json; const userQuery = queryData.query || ''; const preferredOutputFormat = queryData.preferred_output_format || 'summary'; const items = $input.all(); const bookMatches = []; const youtubeMatches = []; for (const item of items) { const data = item.json; if (Array.isArray(data)) { bookMatches.push(...data); } else if (data && typeof data === 'object') { if (data.id && data.snippet) { youtubeMatches.push(data); } else { bookMatches.push(data); } } } let taskType = 'research'; return [{ json: { query: userQuery, taskType: taskType, preferred_output_format: preferredOutputFormat, bookMatches: bookMatches, youtubeMatches: youtubeMatches, totalMatches: bookMatches.length + youtubeMatches.length, timestamp: new Date().toISOString() } }];"
      },
      "id": 
      "name": "Combine Search Results",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        224,
        96
      ]
    },
    {
      "parameters": {
        "modelName": "models/gemini-flash-latest",
        "options": {}
      },
      "id": 
      "name": "Google Gemini Chat Model",
      "type": "@n8n/n8n-nodes-langchain.lmChatGoogleGemini",
      "typeVersion": 1,
      "position": [
        528,
        320
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{ $json.query }}\n\nBook Context:\n{{ JSON.stringify($json.bookMatches) }}\n\nYouTube Context:\n{{ JSON.stringify($json.youtubeMatches) }}\n\nTask Type: {{ $json.taskType }}\nPreferred Format: {{ $json.preferred_output_format }}",
        "options": {
          "systemMessage": "You are a research assistant for HishamSarwarNexus. Answer questions using the provided book and video context. Return JSON response in this exact format: { \"title\": \"Answer to: user's question\", \"summary\": \"Main answer from Hisham's books with book citations\", \"key_points\": [\"Point 1\", \"Point 2\", \"Point 3\"], \"deep_dive\": \"<h3>Detailed Explanation</h3><p>More details...</p>\" }. Use HTML formatting in deep_dive field. Include book titles when citing sources. Keep responses factual and well-structured."
        }
      },
      "id": 
      "name": "AI Research Agent",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        448,
        96
      ]
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "id-1",
              "name": "response",
              "value": "={{ $json.output }}",
              "type": "string"
            },
            {
              "id": "id-2",
              "name": "timestamp",
              "value": "={{ $now.toISO() }}",
              "type": "string"
            },
            {
              "id": "id-3",
              "name": "query_type",
              "value": "={{ $json.taskType }}",
              "type": "string"
            },
            {
              "id": "id-4",
              "name": "parsedResponse",
              "value": "={{ (() => { try { return JSON.parse($json.output); } catch(e) { return { error: 'Invalid JSON', raw: $json.output }; } })() }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "id":
      "name": "Format Final Output",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        800,
        96
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json.parsedResponse }}",
        "options": {
          "responseCode": 200
        }
      },
      "id": 
      "name": "Return to Lovable",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.4,
      "position": [
        1024,
        96
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('Workflow Configuration').first().json.supabaseUrl }}/rest/v1/rpc/match_books",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "apikey",
              "value": 
            {
              "name": "Authorization",
              "value":
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ {\n  \"query_text\": $('Prepare Vector Search Query').first().json.query,\n  \"match_threshold\": 0.7,\n  \"match_count\": $('Workflow Configuration').first().json.topKResults\n} }}",
        "options": {
          "allowUnauthorizedCerts": false,
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "id": 
      "name": "Call Books Vector Search",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        0,
        0
      ]
    },
    {
      "parameters": {
        "resource": "video",
        "limit": 5,
        "filters": {
          "channelId": "UCw3jwyEmeiRdkS22sOjMsSA",
          "q": "={{ $json.query }}"
        },
        "options": {
          "order": "relevance",
          "safeSearch": "none"
        }
      },
      "id": 
      "name": "Search YouTube Videos",
      "type": "n8n-nodes-base.youTube",
      "typeVersion": 1,
      "position": [
        0,
        192
      ]
    }
  ],
  "pinData": {},
  "connections": {
    "Webhook Trigger": {
      "main": [
        [
          {
            "node": "Workflow Configuration",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Workflow Configuration": {
      "main": [
        [
          {
            "node": "Prepare Vector Search Query",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare Vector Search Query": {
      "main": [
        [
          {
            "node": "Call Books Vector Search",
            "type": "main",
            "index": 0
          },
          {
            "node": "Search YouTube Videos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Call Books Vector Search": {
      "main": [
        [
          {
            "node": "Combine Search Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Combine Search Results": {
      "main": [
        [
          {
            "node": "AI Research Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Gemini Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Research Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI Research Agent": {
      "main": [
        [
          {
            "node": "Format Final Output",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Final Output": {
      "main": [
        [
          {
            "node": "Return to Lovable",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Search YouTube Videos": {
      "main": [
        [
          {
            "node": "Combine Search Results",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "versionId":
  "meta": {
    "instanceId": 
  },
  "id": "w_Js_Zu074tJRZ4DzTfmp",
  "tags": []
}
